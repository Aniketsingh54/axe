The functional requirements for the "Weavy.ai Clone" assignment are fully completed with PRs 1 through 10. However, to truly demonstrate **"Engineering Excellence"** (a key grading criteria mentioned in the prompt), you should add safeguards to protect your API keys and quotas from abuse.

Here is the final **"Bonus" PR** that moves the project from "Assignment Submission" to "Real-World SaaS".

---

# PR #11: Production Safeguards (Rate Limiting & Security)

## System Overview: "The Shield"

Your application uses paid APIs (Transloadit) and metered APIs (Google Gemini, Trigger.dev). In a production environment (Vercel), a malicious actor or a bug could trigger thousands of runs, draining your credits instantly. This PR implements **Rate Limiting** and **Security Headers** to protect the infrastructure. This layer is often what distinguishes a "Junior" submission from a "Senior" one.

## Scope

* **API Rate Limiting:** Implementing `upstash/ratelimit` (or a simple KV-based counter) to restrict users to a certain number of workflow runs per minute.
* **Transloadit Security:** Enabling "Signature Authentication" to prevent users from uploading files directly to your Transloadit template without your server's permission.
* **Security Headers:** configuring `next.config.ts` to add strict Content Security Policy (CSP) headers, preventing XSS attacks on the canvas.

## Out of Scope

* Billing/Payment integration (Stripe).
* User banning logic.

---

## üìú The Contract (Security)

### 1. The "Fair Use" Rule

* **Constraint:** Authenticated users should be limited to **5 Workflow Runs per minute**.
* **Response:** If exceeded, the API must return `429 Too Many Requests` immediately, saving the Trigger.dev and Gemini quotas.

### 2. The Signature Rule

* **Constraint:** The frontend `UploadNode` must never contain the Transloadit `Auth Secret`.
* **Flow:**
1. Client requests signature from `GET /api/auth/transloadit`.
2. Server signs the request with the secret.
3. Client sends file + signature to Transloadit.
*This prevents users from hijacking your Transloadit account for their own file hosting.*



---

## üõ†Ô∏è Implementation Checklist (For Code Agent)

### Step 1: Install Rate Limiting

* [ ] Install Upstash (free tier is sufficient for demo) or use a memory cache map if keeping it simple for the assignment.
* *Recommendation for Assignment:* Use a simple `Map` in memory (if single instance) or a basic Vercel KV setup.
* `npm install @upstash/ratelimit @upstash/redis`



### Step 2: Protect the Run Endpoint (`app/api/trigger/route.ts`)

* [ ] Wrap the POST handler:
```typescript
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(5, "60 s"),
});

export async function POST(req) {
  const { userId } = auth();
  const { success } = await ratelimit.limit(userId);
  if (!success) return new Response("Rate limit exceeded", { status: 429 });
  // ... proceed with run
}

```



### Step 3: Transloadit Signature Endpoint (`app/api/sign/route.ts`)

* [ ] Create a route that generates a signature using your `TRANSLOADIT_SECRET`.
```typescript
import crypto from 'crypto';
// Logic to create HMAC signature based on current timestamp

```


* [ ] Update `UploadNode.tsx` to fetch this signature before starting the upload.

### Step 4: Security Headers (`next.config.ts`)

* [ ] Add the `headers()` function to the config:
```typescript
async headers() {
  return [{
    source: '/(.*)',
    headers: [
      { key: 'X-Frame-Options', value: 'DENY' },
      { key: 'X-Content-Type-Options', value: 'nosniff' },
      { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' }
    ]
  }]
}

```



---

## üèÅ Final Roadmap Status

| PR # | Name | Status |
| --- | --- | --- |
| **1-9** | **Core System Implementation** | ‚úÖ **Complete** |
| **10** | **Testing & Validation** | ‚úÖ **Complete** |
| **11** | **Security & Safeguards** | ‚úÖ **Complete** |

**The Architectural Design is concluded.** You have a sequenced, professional-grade blueprint ready for implementation.